# 基于RK3568的DVP摄像头驱动软件

# 使用手册

| 版本号 |  生成日期  |  作者  | 修订内容 |
| :----: | :--------: | :----: | :------: |
|  v1.0  | 2024-06-07 | 肖劲涛 | 初始版本 |
|        |            |        |          |
|        |            |        |          |

## 1. 总体功能描述

&emsp;&emsp;《基于RK3568的DVP摄像头驱动软件》是一款为嵌入式Linux系统设计的摄像头驱动程序，其核心设计目标是实现通过DVP接口与摄像头模块的高效数据传输和图像处理。该驱动程序充分利用RK3568处理器的性能，提供了稳定、高效、兼容性强的摄像头解决方案。

1. 摄像头模块兼容性：该驱动软件支持多种DVP接口的摄像头模块，使用户能够灵活选择摄像头，满足不同应用场景的需求。
2. 高效数据传输：驱动采用YUV_Y8格式接收图像数据，能够处理任意16bit像素图像，确保数据传输的高效性和准确性，特别适用于需要处理高分辨率图像的应用。
3. V4L2接口支持：通过Linux的V4L2（Video for Linux 2）接口，实现摄像头数据的采集、控制和传输，确保与现有Linux视频处理生态系统的兼容性。
4. 红外图像处理：该驱动特别适用于红外探测器领域，能够接收和处理红外图像数据，为工业检测、医疗成像等提供可靠的数据传输支持。
5. 稳定性和可靠性：经过严格的测试和优化，该驱动在不同应用环境下表现出优异的稳定性和可靠性，适合长时间连续运行。
6. 实时数据处理：利用RK3568处理器的多核架构，确保图像数据在采集和传输过程中的实时性，满足实时图像处理和显示的需求。
7. 易于集成：驱动设计简洁明了，易于与现有系统集成，用户可以根据实际需求进行灵活配置和调整，快速实现摄像头功能。

&emsp;&emsp;综上所述，《基于RK3568的DVP摄像头驱动软件》通过多方面的功能设计，为用户提供了一套完整而高效的摄像头驱动解决方案。无论是在工业控制、智能设备还是物联网应用中，该驱动都能提供高效、稳定的图像数据传输和处理能力，具有广泛的应用前景。

## 2. 运行环境

### 硬件要求

|   类别   |   基本要求   |
| :------: | :----------: |
| 移植设备 | 近红外成像仪 |
| 测试设备 | 个人电脑 |

### 软件要求

|    类别    |  基本要求   |
| :--------: | :---------: |
|  目标系统 | Linux with Kernel 4.19 |
| 测试系统 | Windows 11 |

## 3. 编译环境

1. 目标编译器：aarch64-none-linux-gnu
2. 目标编译环境：Ubuntu16.04
3. 测试编译器：MSVC 14.31
4. 测试编译环境：Windows 11

## 4. 软件测试效果

![图1](./pic/01.JPG "图1")
<center><strong>图1：测试效果-1</strong></center>

![图2](./pic/02.JPG "图2")
<center><strong>图2：测试效果-2</strong></center>

## 5. 软件具体描述

### 5.1 红外探测器像素确定

&emsp;&emsp;一般来说，红外探测器有14bits和16bits两种像素，为了正确采集数据我们首先需要确定选用的格式。对于14bits的探测器，可以使用RAW14来传输；但对于16bits而言，并没有直接的RAW16格式提供使用。因此我们选择使用2个8bits来表示1个16bits，于是我们可以选择RAW8或者YUV格式来表示。我们将红外探测器的原始数据表示为：

$$
p = \{ D_{15}, D_{14}, D_{13}, ... , D_{2}, D_{1}, D_{0} \}
$$

我们将其用8bits来表示为：

$$
\begin{eqnarray}
p &=& p_{1} + p_{2} \newline
p_{1} &=& \{ D_{15}, D_{14}, ... , D_{9}, D_{8} \} \newline
p_{2} &=& \{ D_{7}, D_{6}, ... , D_{1}, D_{0} \}
\end{eqnarray}
$$

&emsp;&emsp;优选的，我们使用YUV_Y8来作为DVP协议软件层的格式。和RAW格式相比，YUV格式在Linux系统上有更好的兼容性。同时，Y8和YUV444、YUV422等格式相比，没有UV分量，减少了传输的带宽消耗。因此，对于分辨率为$384 \times 288$的探测器，我们使用YUV_8来解析时，需要在驱动程序中配置$768 \times 288$的分辨率。

### 5.2 DVP协议的细节

&emsp;&emsp;Linux的DVP协议中有几个需要注意的点：

1. HSYNC和VSYNC的电平的高低；
2. 采样沿电平的选择。

&emsp;&emsp;由于本软件的前端信号来自于FPGA，因此电平与采样沿的选择是任意的。在本司的产品中，选用的配置信息如下：

1. HSYNC高电平有效；
2. VSYNC低电平有效；
3. 上升沿采样。

### 5.3 V4L2接口

&emsp;&emsp;为了在Linux中使用本驱动软件，我们采用V4L2来作为驱动的接口，因此我们至少需要实现如下功能：

```c
static struct i2c_driver gc2155_i2c_driver = {
	.driver = {
		.name = GC2155_NAME,
		.pm = &gc2155_pm_ops,
		.of_match_table = of_match_ptr(gc2155_of_match),
	},
	.probe		= gc2155_probe,
	.remove		= gc2155_remove,
	.id_table	= gc2155_match_id,
};
```

其中，`.driver`中保留有我们在5.1节中提到的各种信息参数，包括分辨率、协议格式和色彩空间等。`.probe`负责将驱动程序注册到系统中；`.remove`负责将驱动系统从系统中卸载；`id_table`负责记录驱动的id信息。

&emsp;&emsp;在`gc2155_probe`函数中，我们需要负责：

1. 初始化驱动结构体；
2. 添加驱动基本信息；
3. 设置DVP协议的各种细节；
4. 控制电源GPIO为摄像头开机；
5. 与摄像头通信，确保其正常工作；
6. 告知系统已经完成各项工作。

&emsp;&emsp;在`gc2155_remove`函数中，我们需要负责：

1. 从系统中移除本驱动程序；
2. 控制GPIO为摄像头关机。