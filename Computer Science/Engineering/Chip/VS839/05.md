# 移植 ADB

## 一、环境配置

```sh
# 设置交叉编译环境变量
export CROSS_COMPILE=aarch64-linux-gnu-
export CC=${CROSS_COMPILE}gcc
export CXX=${CROSS_COMPILE}g++
export AR=${CROSS_COMPILE}ar
export STRIP=${CROSS_COMPILE}strip
export RANLIB=${CROSS_COMPILE}ranlib
export PATH="/hdd/System/VS819L/vs-linux/x86-arm/gcc-linaro-7.5.0-aarch64-linux-gnu/bin:$PATH"

# 设置目标系统路径
export ADB_INSTALL_DIR="/hdd/Workspace/VS839_SysDeps/output/adb"
mkdir -p $ADB_INSTALL_DIR
```

## 二、准备依赖

### 2.1 zlib

```sh
# 下载zlib
wget https://zlib.net/zlib-1.3.1.tar.gz
tar -xzvf zlib-1.3.1.tar.gz
cd zlib-1.3.1/

# 配置和编译
export ZLIB_INSTALL_DIR="/hdd/Workspace/VS839_SysDeps/output/zlib"
mkdir -p $ZLIB_INSTALL_DIR

./configure --prefix=$ZLIB_INSTALL_DIR
make CC=$CC AR=$AR RANLIB=$RANLIB
make install

cd ..
```

### 2.2 libcrypto

```sh
# 使用之前编译的OpenSSL
export OPENSSL_ROOT="/hdd/Workspace/VS839_SysDeps/output/openssl"
export ZLIB_ROOT="/hdd/Workspace/VS839_SysDeps/output/zlib"
```

## 三、移植ADBD

```sh
# 设置交叉编译环境变量
export CROSS_COMPILE=aarch64-linux-gnu-
export CC=${CROSS_COMPILE}gcc
export CXX=${CROSS_COMPILE}g++
export AR=${CROSS_COMPILE}ar
export STRIP=${CROSS_COMPILE}strip
export RANLIB=${CROSS_COMPILE}ranlib
export PATH="/hdd/System/VS819L/vs-linux/x86-arm/gcc-linaro-7.5.0-aarch64-linux-gnu/bin:$PATH"

# 设置目标系统路径
export ADB_INSTALL_DIR="/hdd/Workspace/VS839_SysDeps/output/adb"
mkdir -p $ADB_INSTALL_DIR

# 设置依赖库路径
export OPENSSL_ROOT="/hdd/Workspace/VS839_SysDeps/output/openssl"
export ZLIB_ROOT="/hdd/Workspace/VS839_SysDeps/output/zlib"

# 进入android-tools目录
cd /hdd/Workspace/VS839_SysDeps/src/android-tools-4.2.2+git20130218
```

build-adbd下创建一个makefile：

```makefile
# ADB Cross-compilation Makefile for ARM64

# 工具链设置
CROSS_COMPILE = aarch64-linux-gnu-
CC = $(CROSS_COMPILE)gcc
CXX = $(CROSS_COMPILE)g++
AR = $(CROSS_COMPILE)ar
STRIP = $(CROSS_COMPILE)strip

# 依赖库路径
OPENSSL_ROOT = /hdd/Workspace/VS839_SysDeps/output/openssl
ZLIB_ROOT = /hdd/Workspace/VS839_SysDeps/output/zlib

# 编译标志
CFLAGS = -O2 -g -DADB_HOST=0 -Wall -Wno-unused-parameter
CFLAGS += -I../core -I../core/adb -I../core/adbd -I../core/include
CFLAGS += -I../core/include/private -I../core/include/system
CFLAGS += -I../core/include/hardware -I../core/include/cutils
CFLAGS += -I../core/include/utils -I../core/include/log
CFLAGS += -I../core/libcutils -I../core/libcutils/include
CFLAGS += -I../core/liblog -I../core/liblog/include
CFLAGS += -I../core/libutils -I../core/libutils/include
CFLAGS += -I../core/libsparse -I../core/libsparse/include
CFLAGS += -I../core/fastboot -I../core/mkbootimg
CFLAGS += -I../extras -I../extras/ext4_utils
CFLAGS += -I$(OPENSSL_ROOT)/include -I$(ZLIB_ROOT)/include
CFLAGS += -I./compat  # 兼容性头文件目录

# 添加一些常见的定义
CFLAGS += -DANDROID -DHAVE_OFF64_T -DHAVE_SYS_UIO_H
CFLAGS += -DHAVE_PTHREADS -DHAVE_TERMIOS_H
CFLAGS += -DHAVE_SYS_SOCKET_H -DHAVE_STRLCPY
CFLAGS += -D_GNU_SOURCE

LDFLAGS = -L$(OPENSSL_ROOT)/lib -L$(ZLIB_ROOT)/lib
LIBS = -lcrypto -lz -lpthread -lrt

# 源文件路径
SRCDIR = ../core/adb
LIBCUTILS = ../core/libcutils

# 兼容性实现文件
COMPAT_SRCS = \
	compat/property.c \
	compat/android_reboot.c \
	compat/base64.c \
	compat/list.c \
	compat/log_service.c \
	compat/strlcpy.c \
	compat/qemu_pipe.c

# ADB Daemon源文件
ADBD_SRCS = \
	$(SRCDIR)/adb.c \
	$(SRCDIR)/backup_service.c \
	$(SRCDIR)/fdevent.c \
	$(SRCDIR)/transport.c \
	$(SRCDIR)/transport_local.c \
	$(SRCDIR)/transport_usb.c \
	$(SRCDIR)/adb_auth_client.c \
	$(SRCDIR)/sockets.c \
	$(SRCDIR)/services.c \
	$(SRCDIR)/file_sync_service.c \
	$(SRCDIR)/jdwp_service.c \
	$(SRCDIR)/framebuffer_service.c \
	$(SRCDIR)/remount_service.c \
	$(SRCDIR)/usb_linux_client.c \
	$(LIBCUTILS)/socket_inaddr_any_server.c \
	$(LIBCUTILS)/socket_local_client.c \
	$(LIBCUTILS)/socket_local_server.c \
	$(LIBCUTILS)/socket_loopback_client.c \
	$(LIBCUTILS)/socket_loopback_server.c \
	$(LIBCUTILS)/socket_network_client.c \
	$(COMPAT_SRCS)

# 对象文件
ADBD_OBJS = $(ADBD_SRCS:.c=.o)

# 默认目标
all: prepare adbd

# 准备编译环境
prepare:
	@echo "Preparing build environment..."
	@mkdir -p compat
	@$(MAKE) create-compat-files

# 创建兼容性实现文件
create-compat-files: create-compat-headers create-compat-source

create-compat-headers:
	@echo "Creating compatibility header files..."
	@echo '#ifndef _COMPAT_H_' > compat/compat.h
	@echo '#define _COMPAT_H_' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '#include <sys/types.h>' >> compat/compat.h
	@echo '#include <unistd.h>' >> compat/compat.h
	@echo '#include <errno.h>' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// Property system' >> compat/compat.h
	@echo 'int property_get(const char *key, char *value, const char *default_value);' >> compat/compat.h
	@echo 'int property_set(const char *key, const char *value);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// Android reboot' >> compat/compat.h
	@echo 'int android_reboot(int cmd, int flags, const char *arg);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// Base64' >> compat/compat.h
	@echo 'int __b64_pton(const char *src, unsigned char *target, size_t targsize);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// List operations' >> compat/compat.h
	@echo 'struct listnode {' >> compat/compat.h
	@echo '    struct listnode *next;' >> compat/compat.h
	@echo '    struct listnode *prev;' >> compat/compat.h
	@echo '    void *data;' >> compat/compat.h
	@echo '};' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo 'void list_init(struct listnode *node);' >> compat/compat.h
	@echo 'void list_add_tail(struct listnode *head, struct listnode *item);' >> compat/compat.h
	@echo 'void list_remove(struct listnode *item);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// Log service' >> compat/compat.h
	@echo 'const char* get_log_file_path(const char* log_name);' >> compat/compat.h
	@echo 'int log_service(int fd, void* cookie);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// String functions' >> compat/compat.h
	@echo 'size_t strlcpy(char *dst, const char *src, size_t size);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// QEMU' >> compat/compat.h
	@echo 'int qemu_pipe_open(const char* pipename);' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '// TEMP_FAILURE_RETRY macro' >> compat/compat.h
	@echo '#ifndef TEMP_FAILURE_RETRY' >> compat/compat.h
	@echo '#define TEMP_FAILURE_RETRY(expression) \' >> compat/compat.h
	@echo '    ({ \' >> compat/compat.h
	@echo '        long int _result; \' >> compat/compat.h
	@echo '        do _result = (long int) (expression); \' >> compat/compat.h
	@echo '        while (_result == -1L && errno == EINTR); \' >> compat/compat.h
	@echo '        _result; \' >> compat/compat.h
	@echo '    })' >> compat/compat.h
	@echo '#endif' >> compat/compat.h
	@echo '' >> compat/compat.h
	@echo '#endif // _COMPAT_H_' >> compat/compat.h

create-compat-source:
	@echo "Creating compatibility source files..."
	@echo '#include <string.h>' > compat/property.c
	@echo '#include <stdio.h>' >> compat/property.c
	@echo '' >> compat/property.c
	@echo 'int property_get(const char *key, char *value, const char *default_value) {' >> compat/property.c
	@echo '    if (default_value) {' >> compat/property.c
	@echo '        strcpy(value, default_value);' >> compat/property.c
	@echo '        return strlen(default_value);' >> compat/property.c
	@echo '    }' >> compat/property.c
	@echo '    value[0] = '\''\\0'\'';' >> compat/property.c
	@echo '    return 0;' >> compat/property.c
	@echo '}' >> compat/property.c
	@echo '' >> compat/property.c
	@echo 'int property_set(const char *key, const char *value) {' >> compat/property.c
	@echo '    return 0;  // Always succeed' >> compat/property.c
	@echo '}' >> compat/property.c
	
	@echo '#include <sys/reboot.h>' > compat/android_reboot.c
	@echo '#include <unistd.h>' >> compat/android_reboot.c
	@echo '' >> compat/android_reboot.c
	@echo 'int android_reboot(int cmd, int flags, const char *arg) {' >> compat/android_reboot.c
	@echo '    sync();' >> compat/android_reboot.c
	@echo '    return reboot(cmd);' >> compat/android_reboot.c
	@echo '}' >> compat/android_reboot.c
	
	@echo '#include <string.h>' > compat/base64.c
	@echo '#include <stdlib.h>' >> compat/base64.c
	@echo '' >> compat/base64.c
	@echo 'static const char base64_chars[] =' >> compat/base64.c
	@echo '    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";' >> compat/base64.c
	@echo '' >> compat/base64.c
	@echo 'int __b64_pton(const char *src, unsigned char *target, size_t targsize) {' >> compat/base64.c
	@echo '    int len = strlen(src);' >> compat/base64.c
	@echo '    int i, j = 0;' >> compat/base64.c
	@echo '    unsigned char a[4], b[4];' >> compat/base64.c
	@echo '    for (i = 0; i < len; i += 4) {' >> compat/base64.c
	@echo '        for (int k = 0; k < 4; k++) {' >> compat/base64.c
	@echo '            if (i + k < len) {' >> compat/base64.c
	@echo '                char *p = strchr(base64_chars, src[i + k]);' >> compat/base64.c
	@echo '                a[k] = p ? p - base64_chars : 0;' >> compat/base64.c
	@echo '            } else { a[k] = 0; }' >> compat/base64.c
	@echo '        }' >> compat/base64.c
	@echo '        b[0] = (a[0] << 2) | (a[1] >> 4);' >> compat/base64.c
	@echo '        b[1] = (a[1] << 4) | (a[2] >> 2);' >> compat/base64.c
	@echo '        b[2] = (a[2] << 6) | a[3];' >> compat/base64.c
	@echo '        for (int k = 0; k < 3 && j < targsize; k++, j++) {' >> compat/base64.c
	@echo '            target[j] = b[k];' >> compat/base64.c
	@echo '        }' >> compat/base64.c
	@echo '    }' >> compat/base64.c
	@echo '    return j;' >> compat/base64.c
	@echo '}' >> compat/base64.c
	
	@echo '#include <stdlib.h>' > compat/list.c
	@echo '#include <string.h>' >> compat/list.c
	@echo '#include "compat.h"' >> compat/list.c
	@echo '' >> compat/list.c
	@echo 'void list_init(struct listnode *node) {' >> compat/list.c
	@echo '    node->next = node;' >> compat/list.c
	@echo '    node->prev = node;' >> compat/list.c
	@echo '}' >> compat/list.c
	@echo '' >> compat/list.c
	@echo 'void list_add_tail(struct listnode *head, struct listnode *item) {' >> compat/list.c
	@echo '    item->next = head;' >> compat/list.c
	@echo '    item->prev = head->prev;' >> compat/list.c
	@echo '    head->prev->next = item;' >> compat/list.c
	@echo '    head->prev = item;' >> compat/list.c
	@echo '}' >> compat/list.c
	@echo '' >> compat/list.c
	@echo 'void list_remove(struct listnode *item) {' >> compat/list.c
	@echo '    item->next->prev = item->prev;' >> compat/list.c
	@echo '    item->prev->next = item->next;' >> compat/list.c
	@echo '}' >> compat/list.c
	
	@echo '#include <string.h>' > compat/log_service.c
	@echo '' >> compat/log_service.c
	@echo 'const char* get_log_file_path(const char* log_name) {' >> compat/log_service.c
	@echo '    return "/dev/null";' >> compat/log_service.c
	@echo '}' >> compat/log_service.c
	@echo '' >> compat/log_service.c
	@echo 'int log_service(int fd, void* cookie) {' >> compat/log_service.c
	@echo '    return -1;' >> compat/log_service.c
	@echo '}' >> compat/log_service.c
	
	@echo '#include <string.h>' > compat/strlcpy.c
	@echo '' >> compat/strlcpy.c
	@echo 'size_t strlcpy(char *dst, const char *src, size_t size) {' >> compat/strlcpy.c
	@echo '    size_t len = strlen(src);' >> compat/strlcpy.c
	@echo '    if (size > 0) {' >> compat/strlcpy.c
	@echo '        size_t copy_len = (len < size - 1) ? len : size - 1;' >> compat/strlcpy.c
	@echo '        memcpy(dst, src, copy_len);' >> compat/strlcpy.c
	@echo '        dst[copy_len] = '\''\\0'\'';' >> compat/strlcpy.c
	@echo '    }' >> compat/strlcpy.c
	@echo '    return len;' >> compat/strlcpy.c
	@echo '}' >> compat/strlcpy.c
	
	@echo 'int qemu_pipe_open(const char* pipename) {' > compat/qemu_pipe.c
	@echo '    return -1;  // Non-QEMU environment' >> compat/qemu_pipe.c
	@echo '}' >> compat/qemu_pipe.c

# 编译规则
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# 链接adbd
adbd: $(ADBD_OBJS)
	$(CC) $(ADBD_OBJS) -o $@ $(LDFLAGS) $(LIBS)
	$(STRIP) $@

# 清理
clean:
	rm -f $(ADBD_OBJS) adbd

distclean: clean
	rm -rf compat

.PHONY: all clean prepare create-compat-files create-compat-headers create-compat-source distclean
```

