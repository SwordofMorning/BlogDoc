# DPKG 打包与升级

&emsp;&emsp;本文将介绍如何通过`dpkg`打包、安装、升级与卸载`.deb`安装包。

## 一、打包

### 1.1 工程结构

&emsp;&emsp;假设我们有一个如下的应用程序：

```sh
xjt@ubuntu-18:/hdd/Workspace/VS8x9_DPGK_Demo$ tree
.
├── app
│   ├── bin
│   │   └── app.txt
│   ├── init
│   │   └── run.sh
│   └── lib
│       └── lib.txt
└── DEBIAN
```

其中：

1. `app`指目录`/app`，也可以替换为类似的`/usr`、`/bin`等
2. `app`目录下一共安装了三个内容，分别是二进制程序`/app/bin/app.txt`、依赖`/app/lib/lib.txt`，以及启动脚本`/app/init/run.sh`

我们想要将其打包为`.deb`文件，需要在`DEBIAN`下添加如下的内容：

1. `control`，用于描述`.deb`包的内容；
2. `postinst`，用于执行安装后的特定操作；
3. `prerm`，用于升级前的卸载、关闭等操作。

在添加上述文件后，工程如下列所示：

```sh
xjt@ubuntu-18:/hdd/Workspace/VS8x9_DPGK_Demo$ tree
.
├── app
│   ├── bin
│   │   └── app.txt
│   ├── init
│   │   └── run.sh
│   └── lib
│       └── lib.txt
└── DEBIAN
    ├── control
    ├── postinst
    └── prerm
```

### 1.2 文本内容

#### control

```txt
Package: myapp
Version: 1.0.0
Architecture: arm64
Maintainer: Your Name <your.email@example.com>
Description: My Application Package
 This is my custom application for embedded device.
 It includes binary files, libraries and initialization scripts.
Priority: optional
Section: utils
Installed-Size: 1024

```

#### postinst

```sh
#!/bin/sh
# 设置可执行权限
chmod +x /app/init/run.sh
# 创建必要的符号链接或其他初始化操作
echo "Application installed successfully"
exit 0
```

#### prerm

```sh
#!/bin/sh
# 停止可能正在运行的应用程序
# killall your_app_process 2>/dev/null || true
echo "Preparing to remove application"
exit 0
```

&emsp;&emsp;这里需要注意：

1. `control`需要添加一个最后一行的换行符；
2. `postinst`与`prerm`需要添加`755`的权限。

### 1.3 打包

&emsp;&emsp;首先进入到工程的上级目录`/hdd/Workspace`，然后调用`dpkg-deb`对工程文件夹`VS8x9_DPGK_Demo`进行打包，打包后的文件名为`myapp_1.0.0_arm64.deb`。命令如下：

```sh
xjt@ubuntu-18:/hdd/Workspace$ dpkg-deb --build VS8x9_DPGK_Demo myapp_1.0.0_arm64.deb
dpkg-deb: building package 'myapp' in 'myapp_1.0.0_arm64.deb'.
```

## 二、安装

### 2.1 查看包信息

&emsp;&emsp;我们将打包后的安装包传输到板端，并可以通过如下的命令进行简单查看安装包信息：

```sh
# 检查包内容
dpkg-deb -c myapp_1.0.0_arm64.deb

# 查看包信息
dpkg-deb -f myapp_1.0.0_arm64.deb
```

输出结果如下：

```sh
/root # dpkg-deb -c myapp_1.0.0_arm64.deb
drwxrwxr-x xjt/xjt         0 2025-09-29 06:44:32 ./
drwxrwxr-x xjt/xjt         0 2025-09-29 06:41:23 ./app/
drwxrwxr-x xjt/xjt         0 2025-09-29 06:40:56 ./app/bin/
-rw-rw-r-- xjt/xjt         5 2025-09-29 06:40:58 ./app/bin/app.txt
drwxrwxr-x xjt/xjt         0 2025-09-29 06:41:30 ./app/init/
-rw-rw-r-- xjt/xjt        23 2025-09-29 06:41:40 ./app/init/run.sh
drwxrwxr-x xjt/xjt         0 2025-09-29 06:41:08 ./app/lib/
-rw-rw-r-- xjt/xjt        11 2025-09-29 06:41:11 ./app/lib/lib.txt
/root # dpkg-deb -f myapp_1.0.0_arm64.deb
Package: myapp
Version: 1.0.0
Architecture: arm64
Maintainer: Your Name <your.email@example.com>
Description: My Application Package
 This is my custom application for embedded device.
 It includes binary files, libraries and initialization scripts.
Priority: optional
Section: utils
Installed-Size: 1024
/root # 
```

### 2.2 安装

&emsp;&emsp;我们可以直接使用`dpkg -i`来进行安装：

```sh
/root # dpkg -i myapp_1.0.0_arm64.deb
Unpacking myapp (from myapp_1.0.0_arm64.deb)...
Setting up myapp (1.0.0)...
Application installed successfully
```

我们可以检查程序已经完成安装：

```sh
/app # ls -la
total 20
drwxrwxr-x    6 1000     1000          1024 Jan  1 00:06 .
drwxrwxr-x   16 1000     1000          4096 Jan  1 00:00 ..
drwxrwxr-x    2 1000     1000          1024 Jan  1 00:06 bin
drwxrwxr-x    2 1000     1000          1024 Jan  1 00:06 init
drwxrwxr-x    2 1000     1000          1024 Jan  1 00:06 lib
drwxr-xr-x    2 root     root         12288 Jan  1 00:00 lost+found
/app # dpkg -l
    Name           Version
+++-==============-==============
ii  myapp          1.0.0
```

## 三、升级

&emsp;&emsp;假设我们当前的app为1.0.0版本（这里用一个txt做占位表示）：

```sh
/app/bin # cat app.txt 
Ver 1
```

现在我们想要升级到1.1，工作流程如下：

1. 首先替换工程目录下`.app/bin/app.txt`为最新版本；
2. 修改`.DEBIAN/control`中的内容`Version: 1.1.0`；
3. 按照上述的工作流程重新打包一个1.1版本的`.deb`文件：

```sh
xjt@ubuntu-18:/hdd/Workspace$ dpkg-deb --build VS8x9_DPGK_Demo myapp_1.1.0_arm64.deb
dpkg-deb: building package 'myapp' in 'myapp_1.1.0_arm64.deb'.
```

4. 我们将上述`myapp_1.1.0_arm64.deb`传到板端，同样调用dpkg调用命令升级：

```sh
/root # dpkg -i myapp_1.1.0_arm64.deb
Preparing to replace myapp 1.0.0 (using myapp_1.1.0_arm64.deb)...
Preparing to remove application
Setting up myapp (1.1.0)...
Application installed successfully
```

这里dpkg会自行处理依赖与版本管理，我们查看信息同时检查应用是否替换成功：

```sh
/root # dpkg -l
    Name           Version
+++-==============-==============
ii  myapp          1.1.0

/app/bin # cat app.txt 
Ver 2
```

## 四、卸载

&emsp;&emsp;卸载程序有两种方式：

```sh
# 卸载包（保留配置文件）
dpkg -r myapp

# 完全卸载包（包括配置文件）
dpkg -P myapp
```

我们选择第一种演示：

```sh
~ # cd app/
/app # ls
bin         init        lib         lost+found
/app # dpkg -r myapp
Removing myapp (1.1.0)...
Preparing to remove application
/app # ls
lost+found
/app # 
```