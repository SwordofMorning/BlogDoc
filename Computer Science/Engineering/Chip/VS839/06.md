# 移植 uMTPrd (USB MTP Responder Daemon)

是的，**uMTPrd** 是一个优秀的选择！它是专门为嵌入式Linux设备设计的轻量级MTP实现，非常适合你的场景。

## 一、准备工作和环境配置

```sh
# 设置交叉编译环境变量
export CROSS_COMPILE=aarch64-linux-gnu-
export CC=${CROSS_COMPILE}gcc
export CXX=${CROSS_COMPILE}g++
export AR=${CROSS_COMPILE}ar
export STRIP=${CROSS_COMPILE}strip
export RANLIB=${CROSS_COMPILE}ranlib
export PATH="/hdd/System/VS819L/vs-linux/x86-arm/gcc-linaro-7.5.0-aarch64-linux-gnu/bin:$PATH"

# 设置目标系统路径
export UMTPRD_INSTALL_DIR="/hdd/Workspace/VS839_SysDeps/output/umtprd"
mkdir -p $UMTPRD_INSTALL_DIR
```

## 二、下载和编译uMTPrd

```sh
# 1. 下载uMTPrd源码
git clone https://github.com/viveris/uMTPrd.git
cd uMTP-Responder

# 2. 查看依赖和编译选项
cat README.md
ls -la

# 3. 修改Makefile支持交叉编译
cp Makefile Makefile.bak

# 修改Makefile中的编译器设置
sed -i "s/^CC.*=.*/CC = ${CC}/" Makefile
sed -i "s/^AR.*=.*/AR = ${AR}/" Makefile

# 如果Makefile中有strip命令，也要修改
sed -i "s/strip /$(STRIP) /g" Makefile

# 4. 编译uMTPrd
make clean
make

# 5. 检查编译结果
ls -la umtprd
file umtprd
```

## 四、安装和配置

```sh
# 1. 创建安装目录结构
mkdir -p $UMTPRD_INSTALL_DIR/usr/bin
mkdir -p $UMTPRD_INSTALL_DIR/etc/umtprd
mkdir -p $UMTPRD_INSTALL_DIR/var/log

# 2. 复制二进制文件
cp umtprd $UMTPRD_INSTALL_DIR/usr/bin/
chmod +x $UMTPRD_INSTALL_DIR/usr/bin/umtprd
```

配置文件如下：

```conf
# uMTPrd configuration file

# Storage
storage_path="/mnt/storage"

# Device info  
manufacturer="YourCompany"
product="VS839M2 Device"
serial="123456789ABCDEF"
firmware_version="1.0.0"

# USB IDs
usb_vendor_id=0x0e8d
usb_product_id=0x201d

# FunctionFS path
usb_functionfs_path="/dev/ffs-mtp"

# Log
log_level=2
```

板端操作：

```sh
mkdir -p /mnt/storage
echo "Hello from VS839M2!" > /mnt/storage/test.txt
mkdir -p /mnt/storage/Pictures
mkdir -p /mnt/storage/Documents
mkdir -p /var/log

ls -la /mnt/storage/

insmod /lib/modules/libcomposite.ko
insmod /lib/modules/usb_f_fs.ko
insmod /lib/modules/usb_f_mtp.ko

mount -t configfs none /sys/kernel/config 2>/dev/null

mkdir -p /sys/kernel/config/usb_gadget/mtp_gadget
cd /sys/kernel/config/usb_gadget/mtp_gadget
echo 0x0e8d > idVendor
echo 0x201d > idProduct
echo 0x0100 > bcdDevice
echo 0x0200 > bcdUSB
echo 0x00 > bDeviceClass
echo 0x00 > bDeviceSubClass
echo 0x00 > bDeviceProtocol
mkdir -p strings/0x409
echo "123456789ABCDEF" > strings/0x409/serialnumber
echo "YourCompany" > strings/0x409/manufacturer
echo "VS839M2 MTP Device" > strings/0x409/product
mkdir -p configs/c.1
mkdir -p configs/c.1/strings/0x409
echo "MTP Configuration" > configs/c.1/strings/0x409/configuration
echo 250 > configs/c.1/MaxPower
echo 0x80 > configs/c.1/bmAttributes

# 8. 创建FunctionFS function
mkdir -p functions/ffs.mtp
mkdir -p /dev/ffs-mtp
mount -t functionfs mtp /dev/ffs-mtp
ls -la /dev/ffs-mtp/
mountpoint /dev/ffs-mtp
ln -s functions/ffs.mtp configs/c.1/

umtprd &

echo "fa00000.dwc3" > /sys/kernel/config/usb_gadget/mtp_gadget/UDC
```